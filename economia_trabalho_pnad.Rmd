

```{r}
library(haven)
library(tidyr)
library(tidyverse)

#Abrindo PNAD

read_sav("C:/Users/tjrgi/Downloads/PNADC 2022 visita5 (2).sav")  %>% 
  write_csv("Painel 2022.csv")

pnad_clean <- readr::read_csv("Painel 2022.csv")

pnad_clean <- pnad_clean %>%
  mutate(iddom = paste0(UPA, Estrato, V1008))
```

```{r}
library(survey) # Para análise com pesos

# Criar o design com pesos
pnad_design <- svydesign(
  id = ~V1008,           # Cluster primário (exemplo, ajuste conforme necessário)
  strata = ~Estrato,       # Estratos (exemplo, ajuste conforme necessário)
  weights = ~V1032,      # Pesos amostrais
  data = pnad_clean,           # Dados da PNAD
  nest = TRUE            # Indica que os estratos estão aninhados nos clusters
)

pnad <- pnad_design$variables

# Total da população representada (usando projeção como peso)
```


```{r}
#Calculando o número de filhos
filhos <- pnad %>%
  filter(V2005 %in% c(4, 5, 6), V2009 <= 18) %>%
  group_by(iddom) %>%                       # Agrupar por domicílio
  summarise(num_filhos = n())               # Contar o número de filhos por domicílio


# Criar histograma com ggplot2 e eixo X em inteiros
ggplot(filhos, aes(x = num_filhos)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  scale_x_continuous(breaks = seq(floor(min(filhos$num_filhos)), ceiling(max(filhos$num_filhos)), by = 1)) +
  labs(title = "Histograma da Variável de Número de Filhos", 
       subtitle= "Média de número de filhos: 1,65 (PNAD). Taxa de Fecundidade Brasil: 1,87.",
       x = "Número de Filhos", 
       y = "Frequência") +
  theme_classic()


pnad <- pnad %>%
  left_join(filhos, by = "iddom") %>%       # Associar número de filhos ao domicílio
  mutate(num_filhos = ifelse(V2005 %in% c(1, 2, 3), num_filhos, NA)) 


# Visualizar os resultados
media_num_filhos <- mean(pnad$num_filhos, na.rm = TRUE)

str(pnad$num_filhos)
```

```{r}
#Relação entre num_filhos e educação

educ_numfilhos <- pnad %>%
  group_by(VD3005, V2007) %>%  # Agrupamento por anos de educação e sexo
  summarise(
    mean_filhos = mean(num_filhos, na.rm = TRUE),  # Média
    sd_filhos = sd(num_filhos, na.rm = TRUE),     # Desvio-padrão
    n = n()                                       # Tamanho da amostra
  ) %>%
  mutate(
    se_filhos = sd_filhos / sqrt(n)  # Erro padrão da média
  )


ggplot(educ_numfilhos, aes(x = VD3005, y = mean_filhos, color = as.factor(V2007))) +
  geom_line(aes(group = V2007), size = 0.75) +  # Linhas conectando as médias
  geom_point(size = 1) +                    # Pontos para as médias
  geom_ribbon(
    aes(
      ymin = mean_filhos - se_filhos,  # Limite inferior da área
      ymax = mean_filhos + se_filhos,  # Limite superior da área
      fill = as.factor(V2007)
    ),
    alpha = 0.2, linetype = "blank"         # Transparência da área
  ) +
  scale_color_manual(
    values = c("blue", "red"),  # Cores para linhas/pontos
    labels = c("Homem", "Mulher")
  ) +
  scale_fill_manual(
    values = c("blue", "red"),  # Mesmas cores para a área
    labels = c("Homem", "Mulher")
  ) +
  labs(
    title = "Média do Número de Filhos por Anos de Educação",
    subtitle = "Com área de confiança baseada no desvio padrão",
    x = "Anos de Educação (VD3005)",
    y = "Média do Número de Filhos",
    color = "Sexo",
    fill = "Sexo"
  ) +
  theme_classic() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9)
  )
```
```{r}

```


```{r}
filhos_contrafac <- pnad %>%
  select(VD3005, V2007, VD4001, VD4009, num_filhos, V2005, V2009) %>%
  filter(V2009 < 50 & V2009 > 20) %>%
  mutate(num_filhos = ifelse(V2005 %in% c(1,2,3) & is.na(num_filhos), 0, num_filhos))

participacao <- filhos_contrafac %>%
  filter(V2007 == 2 & num_filhos < 6) %>%
  group_by(VD3005, num_filhos) %>%
  summarise(
    ft = sum(VD4001==1, na.rm = TRUE),
    nft = sum(VD4001 == 2, na.rm = TRUE)
  ) %>%
  mutate(tx_partic = ft/(nft+ft))

ggplot() +
  geom_line(data = participacao %>% filter(num_filhos == 0), 
            aes(x = VD3005, y = tx_partic, color = "Sem Filhos"), linewidth = 0.75) +
  geom_line(data = participacao %>% filter(num_filhos == 1), 
            aes(x = VD3005, y = tx_partic, color = "Com 1 Filho"), linewidth = 0.75) +
  geom_line(data = participacao %>% filter(num_filhos == 2), 
            aes(x = VD3005, y = tx_partic, color = "Com 2 Filhos"), linewidth = 0.75) +
  geom_line(data = participacao %>% filter(num_filhos == 3), 
            aes(x = VD3005, y = tx_partic, color = "Com 3 Filhos"), linewidth = 0.75) +
  geom_line(data = participacao %>% filter(num_filhos == 4), 
            aes(x = VD3005, y = tx_partic, color = "Com 4 Filhos"), linewidth = 0.75) +
  scale_color_manual(values = c("Sem Filhos" = "green", "Com 1 Filho" = "orange",
                                "Com 2 Filhos" = "red", "Com 3 Filhos" = "gray", 
                                "Com 4 Filhos" = "black")) +
  theme_classic() +
  labs(
    title = "Taxa de Participação de Mulheres de 25 a 50 anos",
    subtitle = str_wrap("Hipótese considerada: considera-se mulheres de 25 a 50 anos sem filho no domícilio como não tendo filhos."),
    x = "Anos de Educação (VD3005)",
    y = "Taxa de Participação (usa-se VD4001)",
    color = "Mulheres"
  )  # Legenda
```
```{r}
desemprego <- pnad_clean %>%
  filter(V2009 > 25 & V2009 < 65) %>%
  group_by(UF) %>%
  summarise(
    media_salario = mean(VD4019, na.rm = TRUE),
    desemprego = sum((VD4002 == 2)*V1032, na.rm = TRUE),
    emprego = sum((VD4002 == 1)*V1032, na.rm = TRUE)
  ) %>%
  mutate(desemprego_ = (desemprego / (desemprego + emprego))*100)


ggplot() +
  geom_point(data = desemprego, aes(x=desemprego_, y=media_salario)) +
  geom_smooth(data = desemprego, aes(x=desemprego_, y=media_salario), method="lm")
```


```{r}
ggplot() +
  geom_point(data = participacao_uf, aes(x = porc_informal, y = media_salario, color = "Informal"), size = 1) +
  geom_point(data = participacao_uf, aes(x = porc_ft, y = media_salario, color = "Taxa de Participação"), size = 1) +
  geom_smooth(data = participacao_uf, aes(x = porc_informal, y = media_salario, color = "Informal", fill = "Informal"), 
              method = "lm", se = TRUE, linetype = "solid") +
  geom_smooth(data = participacao_uf, aes(x = porc_ft, y = media_salario, color = "Taxa de Participação", fill = "Taxa de Participação"), 
              method = "lm", se = TRUE, linetype = "solid") +
  scale_color_manual(values = c("Informal" = "red", "Taxa de Participação" = "blue")) +
  scale_fill_manual(values = c("Informal" = "pink", "Taxa de Participação" = "lightblue")) +
  theme_classic() +
  labs(
    title = str_wrap("Relação entre Percentual de Informalidade e Taxa de Participação com o Salário Médio das UFs"),
    x = "Percentual Informal (VD4009) e Taxa de Participação (VD4001)",
    y = "Média Salarial das UFs (VD4019)",
    color = "Classificação",
    fill = "Classificação"
  )

  
```

```{r}
pnad_clean$UF <- case_match(pnad_clean$UF,
                            11 ~ "RO",
                            12 ~ "AC",
                            13 ~ "AM",
                            14 ~ "RR",
                            15 ~ "PA",
                            16 ~ "AP",
                            17 ~ "TO",
                            21 ~ "MA",
                            22 ~ "PI",
                            23 ~ "CE",
                            24 ~ "RN",
                            25 ~ "PB",
                            26 ~ "PB",
                            27 ~ "AL",
                            28 ~ "SE",
                            29 ~ "BA",
                            31 ~ "MG",
                            32 ~ "ES",
                            33 ~ "RJ",
                            35 ~ "SP",
                            41 ~ "PR",
                            42 ~ "SC",
                            43 ~ "RS",
                            50 ~ "MS",
                            51 ~ "MT",
                            52 ~ "GO",
                            53 ~ "DF")
```

```{r}
#Investigando taxa de participação 
motivos_partic <- pnad %>%
  group_by(UF, VD4002) %>%
  summarise(percentage = )

motivos_partic_40 <- pnad %>%
  filter(V2007 == 1 & V2009 > 29 & V2009 < 46) %>%
  group_by(UF, VD4001) %>%
  summarise(count = n()) %>%
  
  group_by(UF) %>%
  mutate(percentage = count / sum(count) * 100) %>%  # Calcula a porcentagem


library(writexl)
write_xlsx(motivos_partic_40, "motivos_partic_40.xlsx")

pnad_filtrada <- pnad %>%
  filter(VD4030 == 6 & UF == "CE" & V2009 > 30 & V2009 < 50) %>%
  select(VD4001, VD3005, VD2002, VD4047, V2009, V5002A, V4072A, V4074A, V1023, V1022, V5003A2)

write_xlsx(pnad_filtrada, "pnad_filtrada__.xlsx")


pnad_filtrada$V4074A <- case_match(pnad_filtrada$V4074A,
                                    01~"Conseguiu proposta de trabalho para começar após a semana de referência", 
                                    02~"Estava aguardando resposta de medida tomada para conseguir trabalho ",
                                    03~"Não conseguia trabalho adequado",
                                    04~"Não tinha experiência profissional ou qualificação",
                                    05~"Não conseguia trabalho por ser considerado muito jovem ou muito idoso",
                                    06~"Não havia trabalho na localidade",
                                    07~"Tinha que cuidar dos afazeres domésticos, do(s) filho(s) ou de outro(s) parente(s)", 
                                    08~"Estava estudando (curso de qualquer tipo ou por conta própria)",
                                    09~"Por problema de saúde ou gravidez", 
                                    10~"Outro motivo, especifique")

pnad_filtrada$V1023 <- case_match(pnad_filtrada$V1023,
                                    01~"Capital", 
                                    02~"Resto da RM (Região Metropolitana, excluindo a capital)",
                                    03~"Resto da RIDE (Região Integrada de Desenvolvimento Econômico, excluindo a capital)",
                                    04~"Resto da UF  (Unidade da Federação, excluindo a região metropolitana e a RIDE)")

pnad_filtrada$V5002A <- case_match(pnad_filtrada$V5002A,
                                    01~"Sim", 
                                    02~"Não")

pnad_filtrada$V1022 <- case_match(pnad_filtrada$V1022,
                                    01~"Urbana", 
                                    02~"Rural")

pnad_filtrada$V4076 <- case_match(pnad_filtrada$V4076,
                                    1~"Menos de 1 mês ",
                                    2~"De 1 mês a menos de 1 ano",
                                    3~"De 1 ano a menos de 2 anos",
                                    4~"2 anos ou mais"
)

```


```{r}
tx_partic <- pnad %>%
  group_by(V2007, VD3005) %>%
  summarise(
    sum_ft = sum(VD4001 == 1, na.rm = TRUE),
    sum_nft = sum(VD4001 == 2, na.rm = TRUE)
  ) %>%
  mutate(tx_part = sum_ft/(sum_ft + sum_nft))

ggplot() +
  geom_line(data=tx_partic %>% filter(V2007==2), aes(x=VD3005, y=tx_part), color="red", size = 0.75, linewidth = 1) +
  geom_line(data=tx_partic %>% filter(V2007==1), aes(x=VD3005, y=tx_part), color="blue", size = 0.75, linewidth = 1) +
  labs(
    title="Taxa de Participação por Anos de Educação",
    subtitle="Homem (azul) e Mulher (vermelho)",
    x = "Anos de Educação (VD3005)",
    y = "Taxa de Participação (usa-se VD4001)"
  ) +
  theme_classic()

```

```{r}
pnad_ft <- pnad %>%
  filter(V2009 > 18 & V2009 < 65) %>%
  group_by(V2007, V2010) %>%
  summarise(
    sum_ocup = sum(VD4001 == 1, na.rm = TRUE),
    sum_desocup = sum(VD4001 == 2, na.rm = TRUE)
  ) %>%
  mutate(desocup = sum_desocup / (sum_ocup + sum_desocup))
```
```{r}
# Calcular os decis de renda (removendo NAs da variável de renda)
pnad_data <- pnad %>%
  filter(V2007 == 2) %>%
  filter(!is.na(VD4019)) %>%
  mutate(
    decil_renda = ntile(VD4019, 10)  # Divide a variável em 10 partes iguais
  )

# Calcular a média de filhos por decil
media_filhos_por_decil <- pnad_data %>%
  group_by(decil_renda) %>%
  summarise(media_filhos = mean(num_filhos, na.rm = TRUE))

# Criar o gráfico
ggplot(media_filhos_por_decil, aes(x = decil_renda, y = media_filhos)) +
  geom_line(color = "red", size=1) +  # Gráfico de barras
  labs(
    title = "Número médio de filhos por decil de renda",
    x = "Decil de Renda",
    y = "Número Médio de Filhos"
  ) +
  theme_classic()

```


